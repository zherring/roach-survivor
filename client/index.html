<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>$ROACH Multiplayer</title>
  <!-- OpenGraph meta for Base App / social sharing -->
  <meta property="og:title" content="$ROACH - Stomp or Be Stomped">
  <meta property="og:description" content="Skill-based multiplayer roach survival game. Stomp roaches, earn $ROACH, survive.">
  <meta property="og:image" content="https://roach-survivor-production.up.railway.app/assets/og-image.png">
  <meta property="og:type" content="website">
  <!-- Farcaster miniapp meta -->
  <meta name="fc:frame" content="vNext">
  <meta name="fc:frame:image" content="https://roach-survivor-production.up.railway.app/assets/og-image.png">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #111;
      color: #fff;
      font-family: monospace;
      min-height: 100vh;
      overflow-x: hidden;
      /* Safe area insets for miniapp contexts (notch, nav bars) */
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    h1 { color: #0f0; margin-bottom: 10px; font-size: 18px; }

    /* ==================== DESKTOP 3-COLUMN LAYOUT ==================== */
    #desktop-layout {
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      align-items: flex-start;
      gap: 20px;
      padding: 20px;
      height: 100vh;
    }
    #left-panel {
      flex: 0 0 200px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-top: 5px;
    }
    #center-panel {
      flex: 1 1 0%;
      min-width: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #right-panel {
      flex: 0 0 260px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-top: 5px;
      height: 100%;
    }

    #connection-status {
      color: #f00;
      font-size: 12px;
      margin-bottom: 5px;
    }
    #connection-status.connected { color: #0f0; }

    /* ==================== DESKTOP STATS ==================== */
    #stats {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }
    .stat { color: #aaa; }
    .stat span { color: #ff0; font-weight: bold; }
    #heal-btn {
      background: #040;
      border: 1px solid #0a0;
      color: #0f0;
      font-family: monospace;
      font-size: 10px;
      padding: 2px 6px;
      cursor: pointer;
      margin-left: 5px;
    }
    #heal-btn:hover { background: #060; }
    #heal-btn:disabled { background: #222; border-color: #444; color: #666; cursor: not-allowed; }
    .shop-open-btn {
      width: 100%;
      background: #1b2209;
      border: 1px solid #8a7b2d;
      color: #f0d878;
      font-family: monospace;
      font-size: 11px;
      font-weight: bold;
      padding: 7px 8px;
      cursor: pointer;
    }
    .shop-open-btn:hover { background: #2b3612; }

    /* ==================== UPGRADE SHOP ==================== */
    #upgrade-shop {
      background: #0a0a0a;
      border: 1px solid #333;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 300px;
      overflow-y: auto;
    }
    #upgrade-shop .shop-title {
      color: #0f0;
      font-size: 11px;
      letter-spacing: 0.8px;
      text-transform: uppercase;
    }
    .upgrade-item {
      background: #141414;
      border: 1px solid #2b2b2b;
      padding: 6px;
    }
    .upgrade-meta {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 6px;
      margin-bottom: 4px;
      font-size: 10px;
    }
    .upgrade-name { color: #ddd; }
    .upgrade-level {
      color: #f0c040;
      white-space: nowrap;
    }
    .upgrade-btn {
      width: 100%;
      border: 1px solid #0a0;
      background: #042;
      color: #9f9;
      font-family: monospace;
      font-size: 10px;
      padding: 4px;
      cursor: pointer;
      text-align: center;
    }
    .upgrade-btn:hover { background: #064; }
    .upgrade-btn:disabled {
      border-color: #444;
      background: #1f1f1f;
      color: #666;
      cursor: not-allowed;
    }
    .upgrade-btn.maxed {
      border-color: #7a5;
      background: #2c3a1f;
      color: #cf8;
    }

    #shop-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 5000;
      padding: 14px;
    }
    #shop-modal.visible { display: flex; }
    .shop-modal-layout {
      width: min(920px, 100%);
      max-height: 88vh;
      display: grid;
      grid-template-columns: 300px minmax(0, 1fr);
      gap: 14px;
      align-items: stretch;
    }
    #shop-helper-column {
      display: flex;
      flex-direction: column;
      gap: 0;
      min-height: 0;
    }
    #shop-prospector-text {
      background: #f5f0d0;
      border: 3px solid #555;
      padding: 14px 18px;
      margin-top: -10px;
      width: 100%;
      color: #222;
      font-family: monospace;
      font-size: 15px;
      line-height: 1.5;
      text-align: center;
      overflow-y: auto;
      min-height: 220px;
    }
    #shop-prospector {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      flex-shrink: 0;
    }
    #shop-prospector-face {
      width: 220px;
      height: 220px;
      image-rendering: pixelated;
      flex-shrink: 0;
    }
    #shop-prospector.talking {
      animation: prospector-bob 0.35s ease-in-out infinite;
    }
    #shop-prospector.talking #shop-prospector-face {
      animation: prospector-wiggle-only 0.12s ease-in-out infinite;
    }
    @keyframes prospector-bob {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }
    @keyframes prospector-wiggle-only {
      0%, 100% { transform: rotate(-2.5deg) scale(1); }
      25% { transform: rotate(1.5deg) scale(1.02); }
      50% { transform: rotate(3deg) scale(1); }
      75% { transform: rotate(-1deg) scale(1.01); }
    }
    #shop-panel {
      background: #111;
      border: 1px solid #444;
      box-shadow: 0 18px 42px rgba(0, 0, 0, 0.45);
      padding: 14px 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
      position: relative;
    }
    #close-shop-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      border: 1px solid #555;
      background: #222;
      color: #ddd;
      font-family: monospace;
      font-size: 13px;
      line-height: 1;
      cursor: pointer;
      width: 26px;
      height: 24px;
      padding: 0;
    }
    #close-shop-btn:hover { background: #2f2f2f; }
    .shop-category-row {
      margin-top: 6px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      padding-right: 28px;
    }
    .shop-category-tab {
      border: 0;
      background: transparent;
      cursor: pointer;
      color: #f0d878;
      font-family: monospace;
      font-size: 13px;
      text-transform: none;
      letter-spacing: 0.4px;
      border-bottom: 1px solid #6c5a24;
      padding: 4px 4px 6px;
      text-align: center;
      opacity: 0.7;
      transition: opacity 0.15s ease-out, border-color 0.15s ease-out;
    }
    .shop-category-tab:hover {
      opacity: 0.95;
    }
    .shop-category-tab.active {
      opacity: 1;
      border-bottom-color: #f0d878;
    }
    #shop-modal #upgrade-shop {
      max-height: none;
      flex: 1 1 auto;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      align-items: start;
      background: transparent;
      border: 0;
      padding: 0 2px 0 0;
    }
    .upgrade-column {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .upgrade-column.tab-hidden {
      display: none;
    }
    #shop-modal .upgrade-item {
      background: #0f1014;
      border: 1px solid #2f3338;
    }
    #shop-modal .upgrade-item.purchase-pop {
      animation: shop-item-pop 0.38s cubic-bezier(0.22, 1, 0.36, 1);
      border-color: #57b846;
      box-shadow: 0 0 0 2px rgba(87, 184, 70, 0.25), 0 0 18px rgba(121, 226, 96, 0.35);
    }
    #shop-panel.purchase-flash {
      animation: shop-panel-flash 0.28s ease-out;
    }
    .shop-purchase-float {
      position: fixed;
      z-index: 5200;
      transform: translate(-50%, -50%);
      pointer-events: none;
      font-family: monospace;
      font-size: 12px;
      font-weight: bold;
      letter-spacing: 0.8px;
      color: #ecffd8;
      text-shadow: 0 0 10px rgba(133, 244, 120, 0.9), 1px 1px 0 #103010;
      animation: shop-purchase-float 0.78s ease-out forwards;
      white-space: nowrap;
    }
    .shop-purchase-spark {
      position: fixed;
      z-index: 5200;
      width: 7px;
      height: 7px;
      border-radius: 999px;
      pointer-events: none;
      background: radial-gradient(circle at 35% 35%, #fff6ae 0%, #ffd85a 40%, #79e260 100%);
      box-shadow: 0 0 10px rgba(255, 216, 90, 0.85);
      animation: shop-spark-burst 0.46s ease-out forwards;
      transform: translate(-50%, -50%);
    }
    @keyframes shop-item-pop {
      0% { transform: scale(1); }
      35% { transform: scale(1.04); }
      100% { transform: scale(1); }
    }
    @keyframes shop-panel-flash {
      0% { box-shadow: 0 18px 42px rgba(0, 0, 0, 0.45); }
      35% { box-shadow: 0 18px 42px rgba(0, 0, 0, 0.45), 0 0 24px rgba(113, 226, 100, 0.35); }
      100% { box-shadow: 0 18px 42px rgba(0, 0, 0, 0.45); }
    }
    @keyframes shop-purchase-float {
      0% { opacity: 0; transform: translate(-50%, -46%) scale(0.85); }
      18% { opacity: 1; transform: translate(-50%, -58%) scale(1.05); }
      100% { opacity: 0; transform: translate(-50%, -138%) scale(0.92); }
    }
    @keyframes shop-spark-burst {
      0% { opacity: 1; transform: translate(-50%, -50%) scale(0.4); }
      100% { opacity: 0; transform: translate(calc(-50% + var(--spark-x)), calc(-50% + var(--spark-y))) scale(0.05); }
    }

    /* ==================== DESKTOP MINIMAP ==================== */
    #minimap-canvas {
      border: 1px solid #444;
      background: #111;
      image-rendering: pixelated;
    }

    /* ==================== GAME AREA ==================== */
    #game-wrapper {
      position: relative;
      width: 600px;
      height: 400px;
      overflow: hidden;
    }
    #game-container {
      position: relative;
      width: 600px;
      height: 400px;
      background: #000;
      border: 2px solid #333;
      cursor: none;
      overflow: hidden;
      transform: scale(var(--game-scale, 1));
      transform-origin: top left;
      touch-action: none;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    /* ==================== MOBILE HUD (hidden on desktop) ==================== */
    #mobile-hud { display: none; }
    #mobile-heal-bar { display: none; }
    #mobile-minimap { display: none; }
    #mobile-motel-info { display: none; }

    /* ==================== MOBILE LAYOUT ==================== */
    @media (max-width: 640px) {
      body {
        padding: 0;
        height: 100vh;
        height: 100dvh;
        overflow: hidden;
      }

      /* Collapse 3-col to single column */
      #desktop-layout {
        flex-direction: column;
        align-items: center;
        padding: 0;
        gap: 0;
        min-height: auto;
      }

      /* Hide desktop-only elements */
      #left-panel { display: none; }
      #right-panel { display: none; }
      h1 { display: none; }
      #player-count { display: none; }
      #controls { display: none; }
      #log { display: none; }
      #log-label { display: none; }
      #stats { display: none; }
      #minimap-canvas { display: none; }
      /* On mobile, connection-status is inside hidden left-panel,
         so we force it visible and fixed-position */
      #connection-status {
        display: block !important;
        position: fixed;
        top: 2px;
        right: 46px;
        z-index: 3000;
        font-size: 9px;
        margin: 0;
      }
      #mute-btn {
        top: 2px;
        right: 4px;
        width: 30px;
        height: 30px;
        font-size: 16px;
      }

      /* Game fills width, aspect ratio preserved */
      #game-wrapper {
        width: 100vw;
        /* height computed by JS */
      }
      #game-container {
        border: none;
        border-bottom: 1px solid #333;
      }

      /* Mobile HUD — compact stat bar ABOVE game */
      #mobile-hud {
        display: flex;
        width: 100%;
        padding: 6px 12px;
        background: #0a0a0a;
        border-bottom: 1px solid #222;
        justify-content: space-around;
        align-items: center;
        flex-shrink: 0;
      }
      .hud-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 0;
      }
      .hud-label {
        color: #555;
        font-size: 7px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        line-height: 1;
      }
      .hud-value {
        color: #ff0;
        font-weight: bold;
        font-size: 14px;
        line-height: 1.2;
      }
      .hud-value.banked { color: #f0c040; }
      .hud-value.hp { color: #0f0; }
      .hud-value.kills { color: #f66; }
      #mobile-open-shop-btn {
        background: #1b2209;
        border: 1px solid #8a7b2d;
        color: #f0d878;
        font-family: monospace;
        font-size: 10px;
        font-weight: bold;
        padding: 4px 8px;
      }
      .shop-modal-layout {
        width: min(480px, 100%);
        max-height: 88vh;
        grid-template-columns: 1fr;
      }
      #shop-helper-column {
        order: 2;
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: center;
      }
      #shop-prospector-text {
        min-height: 84px;
        font-size: 13px;
        padding: 12px 14px;
      }
      #shop-prospector {
        width: auto;
        height: auto;
      }
      #shop-prospector-face {
        width: 200px;
        height: 200px;
      }
      #shop-panel {
        min-height: 0;
      }
      .shop-category-row {
        padding-right: 30px;
      }
      #shop-modal #upgrade-shop {
        grid-template-columns: 1fr;
      }

      /* Mobile heal bar — directly under game area */
      #mobile-heal-bar {
        display: block;
        width: 100%;
        padding: 4px 8px;
        background: #0a0a0a;
        flex-shrink: 0;
      }
      #mobile-heal-btn {
        display: block;
        width: 100%;
        background: #040;
        border: 1px solid #0a0;
        color: #0f0;
        font-family: monospace;
        font-size: 14px;
        font-weight: bold;
        padding: 12px;
        cursor: pointer;
        touch-action: manipulation;
      }
      #mobile-heal-btn:disabled {
        background: #1a1a1a;
        border-color: #333;
        color: #444;
      }

      /* Mobile minimap — inline below heal bar */
      #mobile-minimap {
        display: block;
        width: 100%;
        padding: 0;
        background: #0a0a0a;
        flex-shrink: 0;
      }
      #mobile-minimap-canvas {
        display: block;
        width: 100%;
        background: #111;
        image-rendering: pixelated;
      }

      /* Mobile motel info — compact countdown below minimap */
      #mobile-motel-info {
        display: flex;
        width: 100%;
        padding: 4px 12px;
        background: #0a0a0a;
        border-top: 1px solid #1a1a1a;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-family: monospace;
        font-size: 11px;
        flex-shrink: 0;
      }
      #mm-motel-icon {
        color: #f0c040;
        font-weight: bold;
        font-size: 10px;
      }
      #mm-motel-countdown {
        color: #0f0;
        font-weight: bold;
        font-size: 14px;
      }
      #mm-motel-room {
        color: #ff0;
        font-size: 11px;
      }
      #mobile-motel-info.inactive #mm-motel-icon { color: #555; }
      #mobile-motel-info.inactive #mm-motel-countdown { color: #555; }
      #mobile-motel-info.inactive #mm-motel-room { color: #444; }
      #mm-motel-room.here {
        color: #0f0;
        animation: blink 0.5s infinite;
      }

      /* Also hide desktop motel timer on mobile */
      #motel-timer { display: none; }

      /* Joystick: slightly bigger touch target on mobile */
      #joystick-zone {
        bottom: 12px;
        left: 12px;
        width: 110px;
        height: 110px;
      }
    }

    /* ==================== ROACH SPRITES ==================== */
    .roach {
      position: absolute;
      width: 40px;
      height: 40px;
      background-image: url('assets/game-sprite.png');
      background-repeat: no-repeat;
      background-size: 230px 230px;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      background-position: -12px -23px;
      transition: filter 0.1s;
      transform-origin: center center;
      z-index: 10;
      mix-blend-mode: screen;
    }
    .roach.crawling { background-position: -69px -23px; }
    .roach.hurt { background-position: -127px -23px; }
    .roach.hurt::after {
      content: '';
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #ff0000;
      opacity: 0.85;
      animation: hit-flash 0.4s ease-out forwards;
      pointer-events: none;
    }
    @keyframes hit-flash {
      0% { opacity: 0.95; transform: scale(1.3); }
      30% { opacity: 0.9; }
      100% { opacity: 0; transform: scale(1); }
    }
    .roach.dead { background-position: -184px -23px; }
    .roach.rich { filter: brightness(1.2) sepia(0.8) hue-rotate(10deg) saturate(2); }
    .roach.player-self {
      filter: brightness(1.3) sepia(1) hue-rotate(130deg) saturate(3);
      z-index: 20;
    }
    .roach.player-self.rich {
      filter: brightness(1.3) sepia(1) hue-rotate(250deg) saturate(3);
    }
    .roach.player-other {
      filter: brightness(1.3) sepia(1) hue-rotate(200deg) saturate(2);
      z-index: 15;
    }
    .roach.player-other.rich {
      filter: brightness(1.3) sepia(1) hue-rotate(280deg) saturate(2);
    }

    /* Player name label */
    .roach-name {
      position: absolute;
      font-family: monospace;
      font-size: 9px;
      color: #fff;
      text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
      white-space: nowrap;
      pointer-events: none;
      z-index: 200;
      text-align: center;
    }

    /* Player arrow */
    .player-arrow {
      position: absolute;
      z-index: 1000;
      pointer-events: none;
      width: 16px;
      height: 20px;
      image-rendering: pixelated;
    }
    .player-arrow::before {
      content: '';
      position: absolute;
      width: 6px;
      height: 12px;
      background: #ff0000;
      left: 5px;
      top: 0;
      box-shadow: 0 0 0 1px #800000;
    }
    .player-arrow::after {
      content: '';
      position: absolute;
      width: 0; height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 10px solid #ff0000;
      left: 0;
      top: 10px;
      filter: drop-shadow(0 1px 0 #800000);
    }

    /* ==================== BOOT CURSOR ==================== */
    .boot {
      position: absolute;
      width: 115px;
      height: 127px;
      background-image: url('assets/game-sprite.png');
      background-repeat: no-repeat;
      background-size: 344px 344px;
      background-position: -31px -187px;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      pointer-events: none;
      --boot-scale: 1;
      transform: translateX(-50%) translateY(-80%) scale(var(--boot-scale, 1));
      transform-origin: 50% 80%;
      opacity: 0;
      z-index: 100;
      transition: transform 0.1s ease-out;
      filter: brightness(1) sepia(1) hue-rotate(70deg) saturate(2);
      mix-blend-mode: screen;
    }
    .boot.hovering { opacity: 0.6; }
    .boot.stomping {
      background-position: -203px -187px;
      animation: stomp 0.15s ease-out;
    }
    @keyframes stomp {
      0% { opacity: 1; transform: translateX(-50%) translateY(-120%) scale(calc(var(--boot-scale, 1) * 1.2)); }
      50% { opacity: 1; transform: translateX(-50%) translateY(-60%) scale(var(--boot-scale, 1)); }
      100% { opacity: 0.6; transform: translateX(-50%) translateY(-80%) scale(var(--boot-scale, 1)); }
    }

    /* Other players' boot cursors */
    .boot.other-boot {
      opacity: 0.3;
      filter: brightness(1) sepia(1) hue-rotate(180deg) saturate(2);
      transition: none;
    }

    /* ==================== HOUSE BOT ==================== */
    .house-bot {
      position: absolute;
      width: 92px;
      height: 101px;
      background-image: url('assets/game-sprite.png');
      background-repeat: no-repeat;
      background-size: 276px 276px;
      background-position: -26px -150px;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      pointer-events: none;
      z-index: 50;
      transition: left 0.05s linear, top 0.05s linear;
      transform-origin: center center;
      filter: brightness(1) sepia(1) hue-rotate(-30deg) saturate(3);
      mix-blend-mode: screen;
    }
    .house-bot.stomping {
      background-position: -163px -150px;
      animation: bot-stomp 0.25s ease-out;
    }
    @keyframes bot-stomp {
      0% { transform: translateY(-20px) scale(1.3); }
      40% { transform: translateY(18px) scale(1.15); }
      60% { transform: translateY(10px) scale(1.05); }
      100% { transform: translateY(0) scale(1); }
    }

    /* ==================== SCREEN SHAKE ==================== */
    #game-container.shake {
      animation: screen-shake 0.3s ease-out;
    }
    @keyframes screen-shake {
      0%  { transform: scale(var(--game-scale, 1)) translate(0, 0); }
      15% { transform: scale(var(--game-scale, 1)) translate(-4px, 3px); }
      30% { transform: scale(var(--game-scale, 1)) translate(5px, -2px); }
      45% { transform: scale(var(--game-scale, 1)) translate(-3px, 4px); }
      60% { transform: scale(var(--game-scale, 1)) translate(3px, -1px); }
      75% { transform: scale(var(--game-scale, 1)) translate(-1px, 2px); }
      100%{ transform: scale(var(--game-scale, 1)) translate(0, 0); }
    }

    /* ==================== VFX ==================== */
    .shockwave {
      position: absolute;
      width: 120px;
      height: 120px;
      border: 3px solid rgba(255, 50, 0, 0.8);
      border-radius: 50%;
      pointer-events: none;
      z-index: 90;
      animation: shockwave-expand 0.4s ease-out forwards;
    }
    @keyframes shockwave-expand {
      0% { transform: translate(-50%, -50%) scale(0.2); opacity: 1; border-width: 6px; }
      50% { opacity: 0.7; border-width: 3px; }
      100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; border-width: 1px; }
    }

    .splat {
      position: absolute;
      width: 58px;
      height: 58px;
      background-image: url('assets/game-sprite.png');
      background-repeat: no-repeat;
      background-size: 230px 230px;
      background-position: -184px -23px;
      image-rendering: pixelated;
      pointer-events: none;
      filter: brightness(0.6) sepia(1) hue-rotate(60deg) saturate(2);
      animation: splat-fade 1.2s ease-out forwards;
      mix-blend-mode: screen;
    }
    @keyframes splat-fade {
      0% { transform: scale(0.3) rotate(0deg); opacity: 1; }
      15% { transform: scale(1.6) rotate(20deg); opacity: 1; }
      30% { transform: scale(1.3) rotate(15deg); opacity: 0.9; }
      100% { transform: scale(1) rotate(35deg); opacity: 0; }
    }

    .coin {
      position: absolute;
      font-family: monospace;
      font-weight: bold;
      color: #ffd700;
      text-shadow: 0 0 4px #ff8c00, 1px 1px 0 #000;
      pointer-events: none;
      z-index: 500;
      animation: coin-fly var(--fly-duration, 1s) ease-out forwards;
    }
    .coin.big {
      font-size: 18px;
      color: #fff;
      text-shadow: 0 0 8px #ffd700, 0 0 16px #ff4500, 1px 1px 0 #000;
    }
    .coin.hud-fly {
      position: fixed;
      z-index: 1200;
      will-change: transform, opacity;
      animation: none;
    }
    @keyframes coin-fly {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      30% { opacity: 1; }
      100% { transform: translateY(var(--fly-y, -80px)) translateX(var(--fly-x, 0px)) scale(0.5); opacity: 0; }
    }
    #balance.collecting {
      animation: balance-pop 0.35s ease-out;
    }
    @keyframes balance-pop {
      0% { transform: scale(1); color: #ff0; }
      30% { transform: scale(1.35); color: #fff79a; }
      100% { transform: scale(1); color: #ff0; }
    }

    /* ==================== MOTEL ==================== */
    .roach-motel {
      position: absolute;
      width: 240px;
      height: 240px;
      background-color: #000;
      background-image: url('assets/roach-motel-sprite.jpeg');
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      z-index: 5;
    }
    .roach-motel.hidden { display: none !important; }

    .roach.saving::before {
      content: '';
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 255, 100, 0.3);
      pointer-events: none;
      animation: saving-pulse 0.5s ease-in-out infinite;
    }
    @keyframes saving-pulse {
      0%, 100% { background: rgba(0, 255, 100, 0.3); }
      50% { background: rgba(0, 255, 100, 0.5); }
    }

    .heal-burst {
      position: absolute;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(0, 255, 100, 0.7), rgba(0, 255, 100, 0) 70%);
      pointer-events: none;
      z-index: 90;
      animation: heal-burst-anim 0.6s ease-out forwards;
    }
    @keyframes heal-burst-anim {
      0% { transform: scale(0.3); opacity: 1; }
      40% { transform: scale(1.8); opacity: 0.8; }
      100% { transform: scale(2.2); opacity: 0; }
    }

    .save-countdown {
      position: absolute;
      font-family: monospace;
      font-size: 24px;
      font-weight: bold;
      color: #0f0;
      text-shadow: 0 0 10px #0f0, 2px 2px 0 #000;
      pointer-events: none;
      z-index: 500;
    }

    /* ==================== BANK CELEBRATION VFX ==================== */
    .bank-flash {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(circle, rgba(255, 215, 0, 0.4), rgba(255, 165, 0, 0.1) 60%, transparent 80%);
      pointer-events: none;
      z-index: 400;
      animation: bank-flash-anim 0.8s ease-out forwards;
    }
    @keyframes bank-flash-anim {
      0% { opacity: 0; }
      15% { opacity: 1; }
      100% { opacity: 0; }
    }

    .bank-banner {
      position: absolute;
      font-family: monospace;
      font-size: 28px;
      font-weight: bold;
      color: #ffd700;
      text-shadow: 0 0 20px #ffa500, 0 0 40px #ff8c00, 2px 2px 0 #000, -1px -1px 0 #000;
      pointer-events: none;
      z-index: 600;
      text-align: center;
      transform: translateX(-50%);
      animation: bank-banner-rise 2s ease-out forwards;
      white-space: nowrap;
    }
    @keyframes bank-banner-rise {
      0% { transform: translateX(-50%) translateY(0) scale(0.5); opacity: 0; }
      10% { transform: translateX(-50%) translateY(0) scale(1.3); opacity: 1; }
      25% { transform: translateX(-50%) translateY(-10px) scale(1); opacity: 1; }
      70% { opacity: 1; }
      100% { transform: translateX(-50%) translateY(-80px) scale(0.8); opacity: 0; }
    }

    .bank-ring {
      position: absolute;
      width: 180px;
      height: 180px;
      border: 4px solid rgba(255, 215, 0, 0.8);
      border-radius: 50%;
      pointer-events: none;
      z-index: 95;
      animation: bank-ring-expand 0.7s ease-out forwards;
    }
    @keyframes bank-ring-expand {
      0% { transform: translate(-50%, -50%) scale(0.1); opacity: 1; border-width: 6px; }
      40% { opacity: 0.8; border-width: 3px; }
      100% { transform: translate(-50%, -50%) scale(2); opacity: 0; border-width: 1px; }
    }

    .bank-total {
      position: absolute;
      font-family: monospace;
      font-size: 16px;
      font-weight: bold;
      color: #f0c040;
      text-shadow: 0 0 8px #f0c040, 1px 1px 0 #000;
      pointer-events: none;
      z-index: 600;
      text-align: center;
      transform: translateX(-50%);
      animation: bank-total-anim 2s ease-out forwards;
    }
    @keyframes bank-total-anim {
      0% { transform: translateX(-50%) translateY(0) scale(0.8); opacity: 0; }
      15% { transform: translateX(-50%) translateY(0) scale(1.1); opacity: 1; }
      30% { transform: translateX(-50%) translateY(-5px) scale(1); opacity: 1; }
      70% { opacity: 1; }
      100% { transform: translateX(-50%) translateY(-60px) scale(0.7); opacity: 0; }
    }

    #motel-timer {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(0,0,0,0.9);
      border: 2px solid #f0c040;
      padding: 5px 10px;
      font-size: 12px;
      color: #f0c040;
      font-family: monospace;
      z-index: 300;
    }
    #motel-timer.active { color: #0f0; border-color: #0f0; background: rgba(0,50,0,0.9); }
    #motel-timer .room-indicator {
      display: block;
      color: #ff0;
      font-size: 14px;
      font-weight: bold;
      margin-top: 3px;
    }
    #motel-timer .room-indicator.here {
      color: #0f0;
      animation: blink 0.5s infinite;
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    #banked-display { color: #f0c040; font-weight: bold; }

    #controls {
      color: #666;
      font-size: 11px;
      line-height: 1.6;
    }
    #controls kbd {
      background: #333;
      padding: 2px 6px;
      color: #fff;
    }

    #log {
      width: 100%;
      flex: 1 1 0%;
      min-height: 0;
      overflow-y: auto;
      background: #0a0a0a;
      border: 1px solid #333;
      padding: 10px;
      font-size: 11px;
      color: #666;
    }
    #log-label {
      color: #666;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    #log .kill { color: #0f0; }
    #log .death { color: #f00; }
    #log .money { color: #ff0; }

    /* ==================== TUTORIAL OVERLAY ==================== */
    #tutorial-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 9998;
      display: none;
      align-items: center;
      justify-content: center;
    }
    #tutorial-overlay.visible {
      display: flex;
    }
    #tutorial-inner {
      background: #1a1a1a;
      border: 2px solid #555;
      max-width: 420px;
      width: 90%;
      padding: 24px;
      font-family: monospace;
      font-size: 14px;
      color: #ccc;
      line-height: 1.6;
    }
    #tutorial-inner p {
      margin: 0 0 16px 0;
    }
    #tutorial-inner p:last-of-type {
      margin-bottom: 20px;
    }
    #tutorial-inner strong {
      color: #ff0;
    }
    #btn-close-tutorial {
      display: block;
      width: 100%;
      padding: 10px;
      font-family: monospace;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      background: #2a2a2a;
      border: 2px solid #666;
      color: #ccc;
    }
    #btn-close-tutorial:hover { background: #3a3a3a; }

    @media (max-width: 640px) {
      #tutorial-inner { font-size: 13px; padding: 18px; }
    }

    /* ==================== HEAL AFFORDANCE ==================== */
    #heal-hint {
      position: absolute;
      font-family: monospace;
      font-size: 11px;
      font-weight: bold;
      color: #0f0;
      text-shadow: 0 0 6px #0f0, 1px 1px 0 #000, -1px -1px 0 #000;
      white-space: nowrap;
      pointer-events: none;
      z-index: 250;
      opacity: 0;
      transition: opacity 0.3s;
      animation: heal-hint-bob 1s ease-in-out infinite;
    }
    #heal-hint.visible { opacity: 1; }
    @keyframes heal-hint-bob {
      0%, 100% { transform: translateX(-50%) translateY(0); }
      50% { transform: translateX(-50%) translateY(-4px); }
    }

    #player-count {
      color: #0ff;
      font-size: 12px;
      margin-bottom: 5px;
    }

    /* ==================== MUTE BUTTON ==================== */
    #mute-btn {
      position: fixed;
      top: 8px;
      right: 8px;
      z-index: 3000;
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid #444;
      color: #aaa;
      font-family: monospace;
      font-size: 18px;
      width: 36px;
      height: 36px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    #mute-btn:hover { border-color: #888; color: #fff; }
    #mute-btn.muted { color: #f44; border-color: #a00; }

    /* ==================== VIRTUAL JOYSTICK ==================== */
    #joystick-zone {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 120px;
      height: 120px;
      z-index: 2000;
      touch-action: none;
    }
    #joystick-base {
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.08);
      border: 2px solid rgba(255, 255, 255, 0.25);
      border-radius: 50%;
      position: relative;
    }
    #joystick-knob {
      width: 44px;
      height: 44px;
      background: rgba(0, 255, 0, 0.4);
      border: 2px solid rgba(0, 255, 0, 0.7);
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
  </style>
</head>
<body>
  <button id="mute-btn" title="Toggle sound">♪</button>

  <div id="desktop-layout">
    <!-- LEFT PANEL: title, stats, minimap, controls -->
    <div id="left-panel">
      <h1>$ROACH</h1>
      <div id="connection-status">Connecting...</div>
      <div id="player-count"></div>

      <div id="stats">
        <div class="stat">$ROACH: <span id="balance">0.00</span></div>
        <div class="stat" id="banked-display">BANKED: <span id="banked">0.00</span></div>
        <div class="stat">HP: <span id="player-hp">2</span>/2 <button id="heal-btn">Heal ($1)</button></div>
        <div class="stat">Alive: <span id="alive-time">0s</span></div>
        <div class="stat">Kills: <span id="kills">0</span></div>
        <div class="stat">Room: <span id="current-room">1,1</span></div>
      </div>
      <button id="open-shop-btn" class="shop-open-btn">Open Store</button>

      <canvas id="minimap-canvas" width="165" height="165"></canvas>

      <div id="controls">
        <kbd>Click</kbd> stomp<br>
        <kbd>WASD</kbd> steer roach<br>
        <kbd>Space</kbd> heal ($1)<br>
        Walk off edges to change rooms<br>
        Enter <span style="color:#f0c040">MOTEL</span> to bank $ROACH
      </div>
    </div>

    <!-- CENTER PANEL: game area -->
    <div id="center-panel">
      <!-- Mobile HUD — stats above game (shown on mobile only via CSS) -->
      <div id="mobile-hud">
        <div class="hud-group">
          <span class="hud-label">$ROACH</span>
          <span class="hud-value" id="m-balance">0.00</span>
        </div>
        <div class="hud-group">
          <span class="hud-label">Banked</span>
          <span class="hud-value banked" id="m-banked">0.00</span>
        </div>
        <div class="hud-group">
          <span class="hud-label">HP</span>
          <span class="hud-value hp" id="m-hp">2/2</span>
        </div>
        <div class="hud-group">
          <span class="hud-label">Kills</span>
          <span class="hud-value kills" id="m-kills">0</span>
        </div>
        <div class="hud-group">
          <button id="mobile-open-shop-btn">Store</button>
        </div>
      </div>

      <div id="game-wrapper">
        <div id="game-container">
          <div id="boot" class="boot"></div>
          <div id="roach-motel" class="roach-motel hidden"></div>
          <div id="motel-timer">MOTEL: <span id="timer-countdown">--</span><span id="timer-room" class="room-indicator"></span></div>
          <div id="player-arrow" class="player-arrow"></div>
          <div id="heal-hint">SPACE TO HEAL</div>
        </div>
      </div>

      <!-- Mobile heal bar — directly under game (shown on mobile only via CSS) -->
      <div id="mobile-heal-bar">
        <button id="mobile-heal-btn">HEAL $1</button>
      </div>

      <!-- Mobile minimap — below heal bar (shown on mobile only via CSS) -->
      <div id="mobile-minimap"><canvas id="mobile-minimap-canvas" width="150" height="150"></canvas></div>
      <div id="mobile-motel-info">
        <span id="mm-motel-icon">MOTEL</span>
        <span id="mm-motel-countdown">--</span>
        <span id="mm-motel-room"></span>
      </div>
    </div>

    <!-- RIGHT PANEL: event feed -->
    <div id="right-panel">
      <div id="log-label">Feed</div>
      <div id="log"></div>
    </div>
  </div>

  <div id="joystick-zone">
    <div id="joystick-base">
      <div id="joystick-knob"></div>
    </div>
  </div>

  <div id="shop-modal">
    <div class="shop-modal-layout">
      <div id="shop-helper-column">
        <div id="shop-prospector-text">Hover an upgrade and I'll tell ya what it does.</div>
        <div id="shop-prospector">
          <img id="shop-prospector-face" src="assets/prospector-closed.png" alt="Prospector shop helper">
        </div>
      </div>
      <div id="shop-panel">
        <button id="close-shop-btn" aria-label="Close store">x</button>
        <div class="shop-category-row" role="tablist" aria-label="Store categories">
          <button type="button" class="shop-category-tab active" data-store-tab="boot" aria-selected="true">Fer yer Boot</button>
          <button type="button" class="shop-category-tab" data-store-tab="roach" aria-selected="false">Fer yer Roach</button>
        </div>
        <div id="upgrade-shop">
          <div class="upgrade-column" data-store-tab-content="boot">
            <div class="upgrade-item" data-upgrade="bootSize">
              <div class="upgrade-meta">
                <span class="upgrade-name">Boot Size</span>
                <span class="upgrade-level" id="level-bootSize">Lv 0/80</span>
              </div>
              <button class="upgrade-btn" id="upgrade-btn-bootSize">Buy</button>
            </div>
            <div class="upgrade-item" data-upgrade="multiStomp">
              <div class="upgrade-meta">
                <span class="upgrade-name">Multi-stomp</span>
                <span class="upgrade-level" id="level-multiStomp">Lv 0/40</span>
              </div>
              <button class="upgrade-btn" id="upgrade-btn-multiStomp">Buy</button>
            </div>
            <div class="upgrade-item" data-upgrade="rateOfFire">
              <div class="upgrade-meta">
                <span class="upgrade-name">Rate-of-fire</span>
                <span class="upgrade-level" id="level-rateOfFire">Lv 0/120</span>
              </div>
              <button class="upgrade-btn" id="upgrade-btn-rateOfFire">Buy</button>
            </div>
          </div>
          <div class="upgrade-column" data-store-tab-content="roach">
            <div class="upgrade-item" data-upgrade="goldMagnet">
              <div class="upgrade-meta">
                <span class="upgrade-name">Gold Attraction</span>
                <span class="upgrade-level" id="level-goldMagnet">Lv 0/160</span>
              </div>
              <button class="upgrade-btn" id="upgrade-btn-goldMagnet">Buy</button>
            </div>
            <div class="upgrade-item" data-upgrade="wallBounce">
              <div class="upgrade-meta">
                <span class="upgrade-name">Wall Bounce</span>
                <span class="upgrade-level" id="level-wallBounce">Lv 0/60</span>
              </div>
              <button class="upgrade-btn" id="upgrade-btn-wallBounce">Buy</button>
            </div>
            <div class="upgrade-item" data-upgrade="idleIncome">
              <div class="upgrade-meta">
                <span class="upgrade-name">Idle Income</span>
                <span class="upgrade-level" id="level-idleIncome">Lv 0/160</span>
              </div>
              <button class="upgrade-btn" id="upgrade-btn-idleIncome">Buy</button>
            </div>
            <div class="upgrade-item" data-upgrade="shellArmor">
              <div class="upgrade-meta">
                <span class="upgrade-name">Shell Armor</span>
                <span class="upgrade-level" id="level-shellArmor">Lv 0/90</span>
              </div>
              <button class="upgrade-btn" id="upgrade-btn-shellArmor">Buy</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tutorial overlay -->
  <div id="tutorial-overlay">
    <div id="tutorial-inner">
      <p><strong>The Roach:</strong> You control a cockroach. Move with WASD or the on-screen joystick. Stay alive as long as you can — if you get stomped, you lose most of your $ROACH.</p>
      <p><strong>The Boot:</strong> Click or tap to stomp other roaches and steal their $ROACH. Watch out for the red house bot boots — they hunt the richest roaches in each room.</p>
      <p><strong>Spending $ROACH:</strong> $ROACH is distributed every week. Open the store to buy upgrades like bigger boots, faster stomps, and shell armor to earn even more $ROACH.</p>
      <button id="btn-close-tutorial">Got it</button>
    </div>
  </div>

  <script type="module" src="game.js"></script>
</body>
</html>
